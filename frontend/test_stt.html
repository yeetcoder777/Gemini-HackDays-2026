<!doctype html>
<html>
  <body>
    <h2>STT WebSocket Test</h2>
    <button onclick="start()">Start</button>
    <button onclick="stop()">Stop</button>
    <pre id="out"></pre>
    <h3>Live Transcript:</h3>
<div id="transcript"
     style="border:1px solid #ccc; padding:10px; width:600px; min-height:60px; font-size:18px;">
</div>

<h3>Final Transcript:</h3>
<div id="finalTranscript"
     style="border:1px solid #ccc; padding:10px; width:600px; min-height:60px; font-size:18px;">
</div>

    <script>
      let ws, ctx, source, processor, stream;

      function log(msg) {
        document.getElementById("out").textContent += msg + "\n";
      }

      async function start() {
        ws = new WebSocket("ws://127.0.0.1:8000/stt-stream");
        ws.binaryType = "arraybuffer";

        ws.onopen = () => log("WS connected âœ…");

const transcriptDiv = document.getElementById("transcript");
const finalTranscriptDiv = document.getElementById("finalTranscript");

ws.onmessage = (e) => {
  if (typeof e.data !== "string") return; // ignore binary

  let msg;
  try {
    msg = JSON.parse(e.data);
  } catch {
    log("Non-JSON message: " + e.data);
    return;
  }

  if (!msg.text) return;

  if (msg.is_final) {
    finalTranscriptDiv.innerText +=
      (finalTranscriptDiv.innerText ? "\n" : "") + msg.text;
    transcriptDiv.innerText = "";
    log("Final: " + msg.text);
  } else {
    transcriptDiv.innerText = msg.text;
  }
};

        ws.onerror = (e) => log("WS error âŒ");
        ws.onclose = () => log("WS closed");

        stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        // 16kHz is best for whisper
        ctx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
        source = ctx.createMediaStreamSource(stream);

        // ScriptProcessorNode is deprecated but works fine for testing
        processor = ctx.createScriptProcessor(4096, 1, 1);

        processor.onaudioprocess = (event) => {
          if (!ws || ws.readyState !== WebSocket.OPEN) return;

          const input = event.inputBuffer.getChannelData(0); // Float32Array

          // Convert Float32 [-1,1] => Int16 PCM
          const pcm16 = new Int16Array(input.length);
          for (let i = 0; i < input.length; i++) {
            let s = Math.max(-1, Math.min(1, input[i]));
            pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
          }

          ws.send(pcm16.buffer);
        };

        source.connect(processor);
        processor.connect(ctx.destination);

        log("Mic streaming started ðŸŽ™ï¸");
      }

      async function stop() {
        if (processor) processor.disconnect();
        if (source) source.disconnect();
        if (ctx) await ctx.close();
        if (stream) stream.getTracks().forEach(t => t.stop());
        if (ws) ws.close();
        log("Stopped âœ…");
      }
    </script>
  </body>
</html>
